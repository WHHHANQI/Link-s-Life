<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link's Wealth</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="connection-status" style="font-size: 0.8rem; color: #10b981; display: none;">
                âœ… äº‘ç«¯å·²è¿æ¥ (Connected)
            </div>
            <button onclick="toggleConfig()" style="font-size: 0.8rem; padding: 4px 8px; background: #cbd5e1; color: #334155;">
            <button onclick="toggleConfig()" class="secondary" style="font-size: 0.8rem; padding: 6px 12px;">
                âš™ï¸ é…ç½® (Settings)
            </button>
        </div>

        <div class="card" id="config-card" style="display: none; border: 2px dashed #94a3b8;">
            <h3>âš™ï¸ æ•°æ®åº“é…ç½® (Database Config)</h3>
            <p style="font-size: 0.8rem; color: #64748b;">å¹³æ—¶å·²éšè—ï¼Œä¿®æ”¹åç‚¹å‡»ä¿å­˜å³å¯ã€‚</p>
            <input id="ghUser" placeholder="GitHub Username">
            <input id="ghRepo" placeholder="Repository Name" value="Link-s-Life">
            <button onclick="saveConfig()">ä¿å­˜é…ç½® (Save)</button>
        </div>

        <div class="card">
            <h2>ğŸ“ ä»Šæ—¥èµ„äº§ (Today's Assets)</h2>
            <input id="dateInput" type="date">
            <input id="hold" type="number" placeholder="æŒä»“é‡‘é¢ (Holdings)">
            <input id="cash" type="number" placeholder="ç°é‡‘ä½™é¢ (Cash)">
            <button onclick="addRecord()">ä¸Šä¼ æ•°æ® (Upload)</button>
        </div>

        <div class="card">
            <h2>ğŸ“Š å†å²è¶‹åŠ¿ (History)</h2>
            <div id="status"></div>
            <table style="width:100%; text-align:left;">
                <thead><tr><th>æ—¥æœŸ (Date)</th><th>æ€»èµ„äº§ (Total)</th><th>ä»“ä½ (Pos%)</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>

    <script>
        const db = new GithubDB();
        const DATA_FILE = "finance_data.json";

        function toggleConfig() {
            const card = document.getElementById('config-card');
            card.style.display = (card.style.display === 'none') ? 'block' : 'none';
        }

        window.addEventListener('app-ready', async () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            if(db.config.user) document.getElementById('ghUser').value = db.config.user;

            if (db.token) {
                document.getElementById('config-card').style.display = 'none'; 
                document.getElementById('connection-status').style.display = 'block';
            } else {
                document.getElementById('config-card').style.display = 'block';
            }

            const data = await db.load(DATA_FILE);
            if(data) renderTable(data);
        });

        function saveConfig() {
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = prompt("è¯·è¾“å…¥ GitHub Token (Enter Token):"); 
            if(token) {
                db.saveConfig(user, repo, token);
                alert("é…ç½®å·²ä¿å­˜ï¼Saved!");
                location.reload();
            }
        }

        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const hold = Number(document.getElementById('hold').value);
            const cash = Number(document.getElementById('cash').value);
            
            let data = await db.load(DATA_FILE) || [];
            const newRecord = { date, hold, cash, total: hold+cash };
            
            const idx = data.findIndex(d => d.date === date);
            if(idx >= 0) data[idx] = newRecord;
            else data.push(newRecord);

            data.sort((a,b) => new Date(a.date) - new Date(b.date));

            document.getElementById('status').innerText = "Syncing...";
            const success = await db.save(DATA_FILE, data);
            document.getElementById('status').innerText = success ? "âœ… Success" : "âŒ Failed";
            if(success) renderTable(data);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            [...data].reverse().forEach(row => {
                const pos = row.total > 0 ? ((row.hold/row.total)*100).toFixed(1) : 0;
                tbody.innerHTML += `<tr><td>${row.date}</td><td>${row.total}</td><td>${pos}%</td></tr>`;
            });
        }
    </script>
    <script src="js/nav.js"></script> <script>
        renderNav('finance'); 
    </script>
</body>
</html>
