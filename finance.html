<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link's Wealth</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <style>
        /* ç›ˆäºé¢œè‰²å®šä¹‰ */
        .trend-up { color: #dc2626; font-weight: 600; }
        .trend-down { color: #059669; font-weight: 600; }
        .trend-flat { color: #9ca3af; }
        
        .total-assets { font-weight: 800; font-size: 1.05em; color: var(--text-primary); }
        
        /* === ä¿®æ”¹ç‚¹1ï¼šç­–ç•¥ç¬”è®°æ ·å¼ä¼˜åŒ– === */
        .note-item {
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
            padding: 16px;
            border-bottom: 1px dashed var(--border);
            animation: fadeIn 0.3s ease;
        }
        .note-item:last-child { border-bottom: none; }
        
        .note-content { 
            flex: 1; 
            white-space: pre-wrap; 
            font-size: 0.95rem; 
            color: #334151; 
            line-height: 1.5;
        }
        
        /* æ—¥æœŸæ ·å¼ï¼šå˜å¾—éå¸¸å°ä¸”æ·¡ï¼Œç§»åˆ°å†…å®¹ä¸‹æ–¹ */
        .note-date { 
            font-size: 0.7rem; 
            color: #cbd5e1; /* ææµ…çš„ç°è‰² */
            margin-top: 6px;
            font-weight: 300;
        }

        .btn-del { 
            cursor: pointer; color: #d1d5db; padding: 0 0 0 10px; font-size: 1.2rem;
            transition: color 0.2s;
        }
        .btn-del:hover { color: #ef4444; }

        /* === ä¿®æ”¹ç‚¹2ï¼šæ€»æ”¶ç›Šçœ‹æ¿æ ·å¼ === */
        #total-return-card {
            background: linear-gradient(to right, rgba(248, 250, 252, 0.5), rgba(255,255,255,0));
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #cbd5e1; /* é»˜è®¤ç°è‰²æ¡ï¼ŒJSä¼šæ ¹æ®ç›ˆäºå˜è‰² */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div id="connection-status" style="font-size: 0.85rem; color: var(--success); display: none; font-weight: 500;">
                ğŸŸ¢ å®æ—¶æ•°æ®å·²åŒæ­¥ (Live)
            </div>
            <button onclick="toggleConfig()" class="secondary" style="margin-left: auto;">
                âš™ï¸ è®¾ç½® (Config)
            </button>
        </div>

        <div class="card" id="config-card" style="display: none; border: 1px dashed var(--primary);">
            <h3>âš™ï¸ æ•°æ®åº“è¿æ¥ (Database)</h3>
            <input id="ghUser" placeholder="GitHub Username">
            <input id="ghRepo" placeholder="Repository Name" value="Link-s-Life">
            <button onclick="saveConfig()">ä¿å­˜é…ç½® (Save)</button>
        </div>

        <div class="card">
            <h2>ğŸ“ ä»Šæ—¥å¤ç›˜ (Daily Record)</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input id="hold" type="number" placeholder="æŒä»“å¸‚å€¼ (Holdings)">
                <input id="cash" type="number" placeholder="ç°é‡‘ä½™é¢ (Cash)">
            </div>
            <input id="dateInput" type="date">
            <button onclick="addRecord()">ğŸ’¾ æäº¤æ•°æ® (Submit)</button>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç­–ç•¥ä¸è‡ªé€‰ (Strategy)</h2>
            <div style="display: flex; gap: 10px;">
                <input id="noteInput" placeholder="è®°å½•ä½ çš„äº¤æ˜“é€»è¾‘..." style="margin:0;">
                <button onclick="addNote()" style="width: auto; padding: 0 20px;">+</button>
            </div>
            <div id="notesList" style="margin-top: 15px; border-top: 1px solid var(--border);">
                </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š èµ„äº§è¶‹åŠ¿ (Assets Trend)</h2>
            
            <div id="total-return-container">
                </div>

            <div id="status"></div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ (Date)</th>
                            <th>æŒä»“ (Hold)</th>
                            <th>ä½™é¢ (Cash)</th>
                            <th>æ€»èµ„äº§ (Total)</th>
                            <th>ä»“ä½ (Pos)</th>
                            <th style="text-align: right;">ç›ˆäº (P/L)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>
    <script src="js/nav.js"></script>

    <script>
        renderNav('finance');
        const db = new GithubDB();
        const DATA_FILE = "finance_data.json";
        const NOTES_FILE = "finance_notes.json";

        window.addEventListener('app-ready', async () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            if(db.config.user) document.getElementById('ghUser').value = db.config.user;
            if (db.token) {
                document.getElementById('config-card').style.display = 'none'; 
                document.getElementById('connection-status').style.display = 'block';
            } else {
                document.getElementById('config-card').style.display = 'block';
            }
            loadAllData();
        });

        async function loadAllData() {
            const [financeData, notesData] = await Promise.all([
                db.load(DATA_FILE),
                db.load(NOTES_FILE)
            ]);
            if(financeData) renderTable(financeData);
            if(notesData) renderNotes(notesData);
        }

        // === æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼šè®¡ç®—æ€»æ”¶ç›Š ===
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            const totalContainer = document.getElementById('total-return-container');
            
            tbody.innerHTML = "";
            totalContainer.innerHTML = ""; // æ¸…ç©º

            if (!data || data.length === 0) return;

            // 1. è®¡ç®—ç´¯è®¡æ”¶ç›Š (Total Return)
            // data å·²ç»æ˜¯æŒ‰æ—¥æœŸå‡åºæ’åˆ—çš„
            const firstRecord = data[0];
            const lastRecord = data[data.length - 1];
            
            const totalProfit = lastRecord.total - firstRecord.total;
            let totalReturnPct = 0;
            if (firstRecord.total > 0) {
                totalReturnPct = (totalProfit / firstRecord.total) * 100;
            }

            // æ¸²æŸ“é¡¶éƒ¨çš„ç´¯è®¡æ”¶ç›Šå¡ç‰‡
            const sign = totalProfit >= 0 ? "+" : "";
            const color = totalProfit >= 0 ? "#dc2626" : "#059669"; // çº¢/ç»¿
            const borderColor = totalProfit >= 0 ? "#dc2626" : "#059669";
            const fmtMoney = (num) => num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2});

            totalContainer.innerHTML = `
                <div id="total-return-card" style="border-left-color: ${borderColor};">
                    <div>
                        <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">
                            ğŸš€ ç´¯è®¡æ”¶ç›Š (Since ${firstRecord.date})
                        </div>
                        <div style="font-size:1.4rem; font-weight:800; color:${color};">
                            ${sign}${totalReturnPct.toFixed(2)}%
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:0.8rem; color:#64748b; margin-bottom:4px;">
                            ç»å¯¹ç›ˆäº (Net P/L)
                        </div>
                        <div style="font-size:1.1rem; font-weight:600; color:${color};">
                            ${sign}Â¥${fmtMoney(totalProfit)}
                        </div>
                    </div>
                </div>
            `;

            // 2. å‡†å¤‡è¡¨æ ¼æ•°æ®
            let processedData = data.map((item, index) => {
                let pl = 0;
                let plPct = 0;
                if (index > 0) {
                    const prev = data[index - 1];
                    pl = item.total - prev.total;
                    if (prev.total !== 0) plPct = (pl / prev.total) * 100;
                }
                return { ...item, pl, plPct };
            });

            // 3. å€’åºæ¸²æŸ“è¡¨æ ¼
            processedData.reverse().forEach(row => {
                const pos = row.total > 0 ? ((row.hold/row.total)*100).toFixed(1) : "0.0";
                let plClass = "trend-flat";
                let plSign = "";
                if (row.pl > 0) { plClass = "trend-up"; plSign = "+"; }
                if (row.pl < 0) { plClass = "trend-down"; }

                tbody.innerHTML += `
                    <tr>
                        <td style="color:var(--text-secondary); font-size:0.9em;">${row.date}</td>
                        <td>${fmtMoney(row.hold)}</td>
                        <td>${fmtMoney(row.cash)}</td>
                        <td class="total-assets">${fmtMoney(row.total)}</td>
                        <td>${pos}%</td>
                        <td style="text-align: right;" class="${plClass}">
                            <div style="font-size: 0.8rem; opacity: 0.7; font-weight: normal;">
                                ${plSign}${fmtMoney(row.pl)}
                            </div>
                            <div style="font-size: 1.1rem; font-weight: bold;">
                                ${plSign}${row.plPct.toFixed(2)}%
                            </div>
                        </td>
                    </tr>`;
            });
        }

        // === ç¬”è®°éƒ¨åˆ†ä¿®æ”¹ï¼šå¼±åŒ–æ—¥æœŸ ===
        function renderNotes(notes) {
            const list = document.getElementById('notesList');
            list.innerHTML = "";
            if (!notes || notes.length === 0) {
                list.innerHTML = `<div style="padding:15px; text-align:center; color:#ccc; font-size:0.9em;">æš‚æ— ç­–ç•¥è®°å½•</div>`;
                return;
            }

            notes.forEach(note => {
                list.innerHTML += `
                    <div class="note-item">
                        <div class="note-content">
                            <div>${note.content}</div>
                            <div class="note-date">${note.date}</div>
                        </div>
                        <div class="btn-del" onclick="deleteNote(${note.id})">Ã—</div>
                    </div>
                `;
            });
        }
        
        // å…¶ä»–åŸºç¡€å‡½æ•°ä¿æŒä¸å˜
        function toggleConfig() {
            const card = document.getElementById('config-card');
            card.style.display = (card.style.display === 'none') ? 'block' : 'none';
        }
        function saveConfig() {
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = prompt("GitHub Token:"); 
            if(token) {
                db.saveConfig(user, repo, token);
                location.reload();
            }
        }
        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const hold = Number(document.getElementById('hold').value);
            const cash = Number(document.getElementById('cash').value);
            let data = await db.load(DATA_FILE) || [];
            const newRecord = { date, hold, cash, total: hold+cash };
            const idx = data.findIndex(d => d.date === date);
            if(idx >= 0) data[idx] = newRecord;
            else data.push(newRecord);
            data.sort((a,b) => new Date(a.date) - new Date(b.date));
            document.getElementById('status').innerText = "Syncing...";
            const success = await db.save(DATA_FILE, data);
            document.getElementById('status').innerText = success ? "" : "Failed";
            if(success) renderTable(data);
        }
        async function addNote() {
            const input = document.getElementById('noteInput');
            const content = input.value.trim();
            if(!content) return;
            let notes = await db.load(NOTES_FILE) || [];
            notes.unshift({ id: Date.now(), content, date: new Date().toLocaleDateString() });
            await db.save(NOTES_FILE, notes);
            input.value = "";
            renderNotes(notes);
        }
        async function deleteNote(id) {
            if(!confirm("Del?")) return;
            let notes = await db.load(NOTES_FILE) || [];
            notes = notes.filter(n => n.id !== id);
            await db.save(NOTES_FILE, notes);
            renderNotes(notes);
        }
    </script>
</body>
</html>
