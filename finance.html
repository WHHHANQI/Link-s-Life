<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link's Wealth</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* è¿™é‡Œçš„æ ·å¼åªé’ˆå¯¹æœ¬é¡µé¢çš„ç‰¹æ®Šéœ€æ±‚ */
        .trend-up { color: #dc2626; font-weight: 600; } /* ç›ˆï¼šçº¢è‰² */
        .trend-down { color: #059669; font-weight: 600; } /* äºï¼šç»¿è‰² */
        .trend-flat { color: #9ca3af; } /* å¹³ï¼šç°è‰² */
        
        .total-assets { font-weight: 800; font-size: 1.05em; color: var(--text-primary); }
        
        /* ç­–ç•¥ç¬”è®°åˆ—è¡¨æ ·å¼ */
        .note-item {
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start;
            padding: 12px;
            border-bottom: 1px dashed var(--border);
            animation: fadeIn 0.3s ease;
        }
        .note-item:last-child { border-bottom: none; }
        .note-content { flex: 1; white-space: pre-wrap; font-size: 0.95rem; color: #374151; }
        .note-meta { margin-left: 10px; display: flex; align-items: center; gap: 8px; }
        .note-date { font-size: 0.75rem; color: #9ca3af; }
        .btn-del { 
            cursor: pointer; color: #9ca3af; padding: 2px 6px; border-radius: 4px; 
            transition: all 0.2s;
        }
        .btn-del:hover { background: #fee2e2; color: #ef4444; }
    </style>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div id="connection-status" style="font-size: 0.85rem; color: var(--success); display: none; font-weight: 500;">
                ğŸŸ¢ å®æ—¶æ•°æ®å·²åŒæ­¥ (Live)
            </div>
            <button onclick="toggleConfig()" class="secondary" style="margin-left: auto;">
                âš™ï¸ è®¾ç½® (Config)
            </button>
        </div>

        <div class="card" id="config-card" style="display: none; border: 1px dashed var(--primary);">
            <h3>âš™ï¸ æ•°æ®åº“è¿æ¥ (Database)</h3>
            <input id="ghUser" placeholder="GitHub Username">
            <input id="ghRepo" placeholder="Repository Name" value="Link-s-Life">
            <button onclick="saveConfig()">ä¿å­˜é…ç½® (Save)</button>
        </div>

        <div class="card">
            <h2>ğŸ“ ä»Šæ—¥å¤ç›˜ (Daily Record)</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <input id="hold" type="number" placeholder="æŒä»“å¸‚å€¼ (Holdings)">
                <input id="cash" type="number" placeholder="ç°é‡‘ä½™é¢ (Cash)">
            </div>
            <input id="dateInput" type="date">
            <button onclick="addRecord()">ğŸ’¾ æäº¤æ•°æ® (Submit)</button>
        </div>

        <div class="card">
            <h2>ğŸ“ˆ ç­–ç•¥ä¸è‡ªé€‰ (Strategy & Watchlist)</h2>
            <p style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 10px;">
                è®°å½•ä½ çš„é€‰å“é€»è¾‘ã€äº¤æ˜“é“å¾‹æˆ–è§‚å¯Ÿåˆ—è¡¨ã€‚
            </p>
            <div style="display: flex; gap: 10px;">
                <input id="noteInput" placeholder="e.g. çªç ´20æ—¥çº¿ä¹°å…¥ NVDA..." style="margin:0;">
                <button onclick="addNote()" style="width: auto; padding: 0 20px;">+</button>
            </div>
            <div id="notesList" style="margin-top: 15px; border-top: 1px solid var(--border);">
                </div>
        </div>

        <div class="card">
            <h2>ğŸ“Š èµ„äº§è¶‹åŠ¿ (Assets Trend)</h2>
            <div id="status"></div>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>æ—¥æœŸ (Date)</th>
                            <th>æŒä»“ (Hold)</th>
                            <th>ä½™é¢ (Cash)</th>
                            <th>æ€»èµ„äº§ (Total)</th>
                            <th>ä»“ä½ (Pos)</th>
                            <th style="text-align: right;">ç›ˆäº (P/L)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>
    <script src="js/nav.js"></script>

    <script>
        renderNav('finance'); // ç”Ÿæˆå¯¼èˆªæ 

        const db = new GithubDB();
        const DATA_FILE = "finance_data.json";
        const NOTES_FILE = "finance_notes.json"; // æ–°çš„å­˜å‚¨æ–‡ä»¶

        // ç›‘å¬è§£é”ä¿¡å·
        window.addEventListener('app-ready', async () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            
            // é…ç½®å›å¡«
            if(db.config.user) document.getElementById('ghUser').value = db.config.user;

            // è‡ªåŠ¨è¿æ¥é€»è¾‘
            if (db.token) {
                document.getElementById('config-card').style.display = 'none'; 
                document.getElementById('connection-status').style.display = 'block';
            } else {
                document.getElementById('config-card').style.display = 'block';
            }

            // å¹¶è¡ŒåŠ è½½æ•°æ®å’Œç¬”è®°
            loadAllData();
        });

        async function loadAllData() {
            const [financeData, notesData] = await Promise.all([
                db.load(DATA_FILE),
                db.load(NOTES_FILE)
            ]);

            if(financeData) renderTable(financeData);
            if(notesData) renderNotes(notesData);
        }

        // === 1. èµ„äº§è®°å½•é€»è¾‘ ===
        function toggleConfig() {
            const card = document.getElementById('config-card');
            card.style.display = (card.style.display === 'none') ? 'block' : 'none';
        }

        function saveConfig() {
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = prompt("è¯·è¾“å…¥ GitHub Token:"); 
            if(token) {
                db.saveConfig(user, repo, token);
                alert("é…ç½®å·²ä¿å­˜ï¼é¡µé¢å³å°†åˆ·æ–°...");
                location.reload();
            }
        }

        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const hold = Number(document.getElementById('hold').value);
            const cash = Number(document.getElementById('cash').value);
            
            let data = await db.load(DATA_FILE) || [];
            const newRecord = { date, hold, cash, total: hold+cash };
            
            const idx = data.findIndex(d => d.date === date);
            if(idx >= 0) data[idx] = newRecord;
            else data.push(newRecord);

            // æŒ‰æ—¥æœŸå‡åºæ’åºï¼Œæ–¹ä¾¿åç»­è®¡ç®—ç›ˆäº
            data.sort((a,b) => new Date(a.date) - new Date(b.date));

            document.getElementById('status').innerText = "Syncing...";
            const success = await db.save(DATA_FILE, data);
            document.getElementById('status').innerText = success ? "" : "âŒ Failed"; // æˆåŠŸåæ¸…ç©ºæç¤ºï¼Œä¿æŒæ¸…çˆ½
            if(success) renderTable(data);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            
            // æˆ‘ä»¬éœ€è¦å€’åºæ˜¾ç¤ºï¼ˆæœ€è¿‘çš„åœ¨ä¸Šé¢ï¼‰ï¼Œä½†è®¡ç®—ç›ˆäºéœ€è¦æ­£åºå¯¹æ¯”
            // æ‰€ä»¥å…ˆå¤„ç†å¥½å¸¦æœ‰ç›ˆäºæ•°æ®çš„æ•°ç»„
            let processedData = data.map((item, index) => {
                let pl = 0;
                let plPct = 0;
                
                // å¦‚æœä¸æ˜¯ç¬¬ä¸€å¤©ï¼Œå°±å’Œå‰ä¸€å¤©å¯¹æ¯”
                if (index > 0) {
                    const prev = data[index - 1];
                    pl = item.total - prev.total;
                    if (prev.total !== 0) {
                        plPct = (pl / prev.total) * 100;
                    }
                }
                return { ...item, pl, plPct };
            });

            // å€’åºæ¸²æŸ“
            processedData.reverse().forEach(row => {
                const pos = row.total > 0 ? ((row.hold/row.total)*100).toFixed(1) : "0.0";
                
                // å¤„ç†ç›ˆäºæ ·å¼
                let plClass = "trend-flat";
                let plSign = "";
                if (row.pl > 0) { plClass = "trend-up"; plSign = "+"; } // çº¢æ¶¨
                if (row.pl < 0) { plClass = "trend-down"; } // ç»¿è·Œ
                
                // æ ¼å¼åŒ–æ•°å­—ï¼ˆåŠ é€—å·ï¼‰
                const fmt = (num) => num.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 2});

                tbody.innerHTML += `
                    <tr>
                        <td style="color:var(--text-secondary); font-size:0.9em;">${row.date}</td>
                        <td>${fmt(row.hold)}</td>
                        <td>${fmt(row.cash)}</td>
                        <td class="total-assets">${fmt(row.total)}</td>
                        <td>${pos}%</td>
                        
                        <td style="text-align: right;" class="${plClass}">
                            <div style="font-size: 0.8rem; opacity: 0.7; font-weight: normal;">
                                ${plSign}${fmt(row.pl)}
                            </div>
                            
                            <div style="font-size: 1.1rem; font-weight: bold;">
                                ${plSign}${row.plPct.toFixed(2)}%
                            </div>
                        </td>
                        </tr>`;
            });
        }

        // === 2. ç­–ç•¥ç¬”è®°é€»è¾‘ (æ–°å¢) ===
        async function addNote() {
            const input = document.getElementById('noteInput');
            const content = input.value.trim();
            if(!content) return;

            let notes = await db.load(NOTES_FILE) || [];
            
            const newNote = {
                id: Date.now(),
                content: content,
                date: new Date().toLocaleDateString()
            };

            // æ–°ç¬”è®°æ’åœ¨æœ€å‰é¢
            notes.unshift(newNote);
            
            await db.save(NOTES_FILE, notes);
            input.value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
            renderNotes(notes);
        }

        function renderNotes(notes) {
            const list = document.getElementById('notesList');
            list.innerHTML = "";
            
            if (!notes || notes.length === 0) {
                list.innerHTML = `<div style="padding:15px; text-align:center; color:#ccc; font-size:0.9em;">æš‚æ— ç­–ç•¥è®°å½• (No notes yet)</div>`;
                return;
            }

            notes.forEach(note => {
                list.innerHTML += `
                    <div class="note-item">
                        <div class="note-content">
                            ${note.content}
                            <div class="note-meta">ğŸ“… ${note.date}</div>
                        </div>
                        <div class="btn-del" onclick="deleteNote(${note.id})">Ã—</div>
                    </div>
                `;
            });
        }

        async function deleteNote(id) {
            if(!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡ç­–ç•¥å—ï¼Ÿ")) return;
            let notes = await db.load(NOTES_FILE) || [];
            notes = notes.filter(n => n.id !== id);
            await db.save(NOTES_FILE, notes);
            renderNotes(notes);
        }

    </script>
</body>
</html>
