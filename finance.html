<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link's Life - 资产</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="navbar">
        <div class="brand">Link's Life</div>
        <div class="nav-links">
            <a href="index.html">🏠 关于我</a>
            <a href="finance.html" class="active">💰 资产记录</a>
            <a href="wishes.html">✨ 愿望影集</a>
        </div>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="connection-status" style="font-size: 0.8rem; color: #10b981; display: none;">
                ✅ 云端已连接
            </div>
            <button onclick="toggleConfig()" style="font-size: 0.8rem; padding: 4px 8px; background: #cbd5e1; color: #334155;">
                ⚙️ 配置 / 切换仓库
            </button>
        </div>

        <div class="card" id="config-card" style="display: none; border: 2px dashed #94a3b8;">
            <h3>⚙️ 数据库配置</h3>
            <p style="font-size: 0.8rem; color: #64748b;">平时已隐藏，修改后点击保存即可。</p>
            <input id="ghUser" placeholder="GitHub Username">
            <input id="ghRepo" placeholder="Repository Name" value="Link-s-Life">
            <button onclick="saveConfig()">保存配置</button>
        </div>

        <div class="card">
            <h2>📝 今日资产</h2>
            <input id="dateInput" type="date">
            <input id="hold" type="number" placeholder="持仓金额">
            <input id="cash" type="number" placeholder="现金余额">
            <button onclick="addRecord()">上传数据</button>
        </div>

        <div class="card">
            <h2>📊 历史趋势</h2>
            <div id="status"></div>
            <table style="width:100%; text-align:left;">
                <thead><tr><th>日期</th><th>总资产</th><th>仓位</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>

    <script>
        const db = new GithubDB();
        const DATA_FILE = "finance_data.json";

        // 切换配置框的显示/隐藏
        function toggleConfig() {
            const card = document.getElementById('config-card');
            if (card.style.display === 'none') {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        }

        // 监听 app-ready 信号
        window.addEventListener('app-ready', async () => {
            console.log("App Unlocked...");
            
            document.getElementById('dateInput').valueAsDate = new Date();
            
            // 回填输入框
            if(db.config.user) document.getElementById('ghUser').value = db.config.user;

            // === 核心逻辑修改 ===
            // 1. 如果有 Token，说明配置过了：
            if (db.token) {
                // 隐藏配置框
                document.getElementById('config-card').style.display = 'none'; 
                // 显示“已连接”小绿字
                document.getElementById('connection-status').style.display = 'block';
            } else {
                // 2. 如果没 Token，说明是第一次用，或者清空了缓存：
                // 强制展开配置框，提醒用户输入
                document.getElementById('config-card').style.display = 'block';
            }

            // 加载数据
            const data = await db.load(DATA_FILE);
            if(data) renderTable(data);
        });

        function saveConfig() {
            const user = document.getElementById('ghUser').value;
            const repo = document.getElementById('ghRepo').value;
            const token = prompt("请输入 GitHub Token:"); 
            if(token) {
                db.saveConfig(user, repo, token);
                alert("配置已保存！刷新生效。");
                location.reload();
            }
        }

        async function addRecord() {
            const date = document.getElementById('dateInput').value;
            const hold = Number(document.getElementById('hold').value);
            const cash = Number(document.getElementById('cash').value);
            
            let data = await db.load(DATA_FILE) || [];
            const newRecord = { date, hold, cash, total: hold+cash };
            
            const idx = data.findIndex(d => d.date === date);
            if(idx >= 0) data[idx] = newRecord;
            else data.push(newRecord);

            data.sort((a,b) => new Date(a.date) - new Date(b.date));

            document.getElementById('status').innerText = "同步中...";
            const success = await db.save(DATA_FILE, data);
            document.getElementById('status').innerText = success ? "✅ 同步成功" : "❌ 失败";
            if(success) renderTable(data);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            [...data].reverse().forEach(row => {
                const pos = row.total > 0 ? ((row.hold/row.total)*100).toFixed(1) : 0;
                tbody.innerHTML += `<tr><td>${row.date}</td><td>${row.total}</td><td>${pos}%</td></tr>`;
            });
        }
    </script>
</body>
</html>
