<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For CC - Success Journal</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <style>
        /* ç²‰è‰²ä¸»é¢˜å¾®è°ƒ */
        .card h2::before { background-color: #ec4899; box-shadow: 0 0 10px #ec4899; }
        .journal-date { color: #db2777; background: rgba(236, 72, 153, 0.08); }
        
        /* æŒ‰é’®ç»„æ ·å¼ */
        .action-btns {
            display: flex;
            gap: 10px;
        }
        .btn-icon {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }
        .btn-edit { color: #3b82f6; background: rgba(59, 130, 246, 0.1); } /* è“è‰²ç¼–è¾‘ */
        .btn-edit:hover { background: rgba(59, 130, 246, 0.2); }
        
        .btn-del { color: #ef4444; background: rgba(239, 68, 68, 0.1); } /* çº¢è‰²åˆ é™¤ */
        .btn-del:hover { background: rgba(239, 68, 68, 0.2); }

        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„å–æ¶ˆæŒ‰é’® */
        #cancelBtn {
            background-color: #94a3b8;
            margin-top: 10px;
            display: none; /* é»˜è®¤éšè— */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>ğŸ’– é™ˆé™ˆçš„æˆåŠŸæ—¥è®° (CC's Journal)</h2>
            <p style="font-size: 0.8rem; color: #64748b;">
                äº²çˆ±çš„é™ˆé™ˆï¼Œè®°å½•ä¸‹ä»Šå¤©å‘ç”Ÿçš„å°ç¡®å¹¸æˆ–å°æˆå°±å§~<br>
                Record your daily wins, my dear CC.
            </p>
            
            <input id="dateInput" type="date">
            
            <textarea id="journalInput" rows="6" 
                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit;" 
                placeholder="1. ä»Šå¤©å–åˆ°äº†å¥½å–çš„å¥¶èŒ¶&#10;2. å®Œæˆäº†å·¥ä½œä»»åŠ¡&#10;3. å¼€å¿ƒï¼"></textarea>
            
            <button id="saveBtn" onclick="saveJournal()" style="margin-top: 10px; width: 100%; background: linear-gradient(135deg, #ec4899, #db2777);">
                ğŸ’¾ ä¿å­˜ (Save)
            </button>
            
            <button id="cancelBtn" onclick="cancelEdit()" style="width: 100%;">
                âœ–ï¸ å–æ¶ˆç¼–è¾‘ (Cancel Edit)
            </button>
        </div>

        <div id="journalGrid">
            </div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>
    <script src="js/nav.js"></script>

    <script>
        renderNav('cc');

        const db = new GithubDB();
        const FILE_NAME = "cc_journal.json"; 
        let localData = [];
        
        // ã€æ ¸å¿ƒé€»è¾‘ã€‘ç¼–è¾‘çŠ¶æ€æ ‡è®°
        // null = æ–°å¢æ¨¡å¼; æœ‰æ•°å€¼ = æ­£åœ¨ç¼–è¾‘è¯¥ ID çš„æ¡ç›®
        let editingId = null; 

        window.addEventListener('app-ready', async () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            
            const data = await db.load(FILE_NAME);
            if(data) {
                localData = data;
                renderJournals();
            }
        });

        // 1. ä¿å­˜/æ›´æ–°é€»è¾‘ (äºŒåˆä¸€)
        async function saveJournal() {
            const date = document.getElementById('dateInput').value;
            const content = document.getElementById('journalInput').value;
            
            if(!content.trim()) return alert("å†™ç‚¹ä»€ä¹ˆå§~");

            if (editingId) {
                // === æ›´æ–°æ¨¡å¼ ===
                // æ‰¾åˆ°é‚£æ¡æ—§æ•°æ®ï¼Œæ›´æ–°å®ƒ
                const index = localData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    localData[index].date = date;
                    localData[index].content = content;
                }
                alert("å·²æ›´æ–°ï¼Updated!");
            } else {
                // === æ–°å¢æ¨¡å¼ ===
                const newEntry = { 
                    id: Date.now(), 
                    date, 
                    content 
                };
                localData.push(newEntry);
            }

            // é‡æ–°æ’åºå¹¶ä¿å­˜
            localData.sort((a,b) => new Date(b.date) - new Date(a.date));
            await db.save(FILE_NAME, localData);
            
            // é‡ç½®çŠ¶æ€
            resetForm();
            renderJournals();
        }

        // 2. å¼€å§‹ç¼–è¾‘
        function startEdit(id) {
            const item = localData.find(i => i.id === id);
            if (!item) return;

            // 1. å›å¡«æ•°æ®åˆ°è¾“å…¥æ¡†
            document.getElementById('dateInput').value = item.date;
            document.getElementById('journalInput').value = item.content;
            
            // 2. æ ‡è®°æ­£åœ¨ç¼–è¾‘çš„ID
            editingId = id;

            // 3. æ”¹å˜ç•Œé¢çŠ¶æ€
            document.getElementById('saveBtn').innerText = "ğŸ”„ æ›´æ–° (Update)";
            document.getElementById('cancelBtn').style.display = "block"; // æ˜¾ç¤ºå–æ¶ˆæŒ‰é’®
            
            // 4. æ»šå›åˆ°é¡¶éƒ¨æ–¹ä¾¿ç¼–è¾‘
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 3. å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            resetForm();
        }

        // 4. é‡ç½®è¡¨å•åˆ°åˆå§‹çŠ¶æ€
        function resetForm() {
            editingId = null;
            document.getElementById('journalInput').value = "";
            document.getElementById('dateInput').valueAsDate = new Date();
            
            // è¿˜åŸæŒ‰é’®
            document.getElementById('saveBtn').innerText = "ğŸ’¾ ä¿å­˜ (Save)";
            document.getElementById('cancelBtn').style.display = "none";
        }

        function renderJournals() {
            const grid = document.getElementById('journalGrid');
            grid.innerHTML = "";
            
            localData.forEach(item => {
                grid.innerHTML += `
                    <div class="card">
                        <div class="journal-date">
                            <span>ğŸ“… ${item.date}</span>
                            <div class="action-btns">
                                <span class="btn-icon btn-edit" onclick="startEdit(${item.id})">âœ ç¼–è¾‘</span>
                                <span class="btn-icon btn-del" onclick="deleteJournal(${item.id})">Ã— åˆ é™¤</span>
                            </div>
                        </div>
                        <div class="journal-content" style="white-space: pre-wrap;">${item.content}</div>
                    </div>
                `;
            });
        }

        async function deleteJournal(id) {
            if(!confirm("ç¡®å®šåˆ é™¤è¿™æ¡å—ï¼Ÿ")) return;
            // å¦‚æœæ­£åœ¨ç¼–è¾‘è¿™æ¡ï¼Œå…ˆé€€å‡ºç¼–è¾‘æ¨¡å¼
            if (editingId === id) cancelEdit();
            
            localData = localData.filter(i => i.id !== id);
            await db.save(FILE_NAME, localData);
            renderJournals();
        }
    </script>
</body>
</html>
