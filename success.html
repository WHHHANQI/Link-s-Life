<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link's Success Journal</title>
    <link rel="stylesheet" href="css/style.css?v=2">
    <style>
        .journal-date {
            font-weight: 600;
            color: var(--primary);
            border-bottom: 1px solid #f1f5f9;
            padding-bottom: 8px;
            margin-bottom: 10px;
            display: flex; 
            justify-content: space-between;
            align-items: center;
        }
        .journal-content {
            white-space: pre-wrap; 
            line-height: 1.6;
            color: #334151;
        }
        
        /* æç®€æŒ‰é’®æ ·å¼ */
        .action-btns { display: flex; gap: 12px; }
        .btn-icon { cursor: pointer; font-size: 1.1rem; transition: transform 0.2s; }
        .btn-icon:hover { transform: scale(1.2); }
        .btn-edit { color: #3b82f6; } /* è“è‰²é“…ç¬” */
        .btn-del { color: #ef4444; }  /* çº¢è‰²å‰å‰ */

        /* å–æ¶ˆæŒ‰é’®é»˜è®¤éšè— */
        #cancelBtn { display: none; background-color: #94a3b8; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h2>ğŸ† ä»Šæ—¥æˆåŠŸæ—¥è®° (Today's Success)</h2>
            <p style="font-size: 0.8rem; color: #64748b;">
                æ¯å¤©è®°å½• 5 ä»¶åšæˆåŠŸçš„äº‹ã€‚åŒä¸€å¤©åªèƒ½è®°å½•ä¸€æ¡å“¦ã€‚<br>
                One entry per day.
            </p>
            
            <input id="dateInput" type="date">
            
            <textarea id="journalInput" rows="8" 
                style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-family: inherit;" 
                placeholder="1. ...&#10;2. ..."></textarea>
            
            <button id="saveBtn" onclick="saveJournal()" style="width: 100%;">ğŸ’¾ ä¿å­˜æ—¥è®° (Save)</button>
            <button id="cancelBtn" onclick="cancelEdit()" style="width: 100%;">âœ–ï¸ å–æ¶ˆç¼–è¾‘ (Cancel)</button>
        </div>

        <div id="journalGrid"></div>
    </div>

    <script src="js/db.js"></script>
    <script src="js/lock.js"></script>
    <script src="js/nav.js"></script>

    <script>
        renderNav('success');
        const db = new GithubDB();
        const FILE_NAME = "success_journal.json"; 
        let localData = [];
        let editingId = null; // ç¼–è¾‘çŠ¶æ€æ ‡è®°

        window.addEventListener('app-ready', async () => {
            document.getElementById('dateInput').valueAsDate = new Date();
            const data = await db.load(FILE_NAME);
            if(data) {
                localData = data;
                renderJournals();
            }
        });

        async function saveJournal() {
            const date = document.getElementById('dateInput').value;
            const content = document.getElementById('journalInput').value;
            
            if(!content.trim()) return alert("è¯·å¡«å†™å†…å®¹ (Content is required)");

            // === æ ¸å¿ƒé€»è¾‘ï¼šé˜²é‡å¤æ£€æŸ¥ ===
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ã€æ—¥æœŸç›¸åŒã€‘ä¸”ã€ä¸æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„é‚£ä¸€æ¡ã€‘çš„è®°å½•
            const duplicate = localData.find(item => item.date === date && item.id !== editingId);
            
            if (duplicate) {
                alert(`ğŸ“… ${date} çš„æ—¥è®°å·²ç»å­˜åœ¨äº†ï¼\nè¯·ç›´æ¥ç¼–è¾‘ä¸‹é¢åˆ—è¡¨ä¸­å½“å¤©çš„è®°å½•ã€‚`);
                return; // é˜»æ­¢ä¿å­˜
            }

            if (editingId) {
                // æ›´æ–°æ¨¡å¼
                const index = localData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    localData[index].date = date;
                    localData[index].content = content;
                }
                alert("æ—¥è®°å·²æ›´æ–° (Updated)");
            } else {
                // æ–°å¢æ¨¡å¼
                const newEntry = { id: Date.now(), date, content };
                localData.push(newEntry);
            }
            
            // æ’åºå¹¶ä¿å­˜
            localData.sort((a,b) => new Date(b.date) - new Date(a.date));
            await db.save(FILE_NAME, localData);
            
            resetForm();
            renderJournals();
        }

        function startEdit(id) {
            const item = localData.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('dateInput').value = item.date;
            document.getElementById('journalInput').value = item.content;
            editingId = id;

            document.getElementById('saveBtn').innerText = "ğŸ”„ æ›´æ–°æ—¥è®° (Update)";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function cancelEdit() {
            resetForm();
        }

        function resetForm() {
            editingId = null;
            document.getElementById('journalInput').value = "";
            document.getElementById('dateInput').valueAsDate = new Date();
            document.getElementById('saveBtn').innerText = "ğŸ’¾ ä¿å­˜æ—¥è®° (Save)";
            document.getElementById('cancelBtn').style.display = "none";
        }

        function renderJournals() {
            const grid = document.getElementById('journalGrid');
            grid.innerHTML = "";
            
            localData.forEach(item => {
                grid.innerHTML += `
                    <div class="card">
                        <div class="journal-date">
                            <span>ğŸ“… ${item.date}</span>
                            <div class="action-btns">
                                <span class="btn-icon btn-edit" onclick="startEdit(${item.id})" title="ç¼–è¾‘">âœ</span>
                                <span class="btn-icon btn-del" onclick="deleteJournal(${item.id})" title="åˆ é™¤">Ã—</span>
                            </div>
                        </div>
                        <div class="journal-content">${item.content}</div>
                    </div>
                `;
            });
        }

        async function deleteJournal(id) {
            if(!confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
            if (editingId === id) cancelEdit();
            localData = localData.filter(i => i.id !== id);
            await db.save(FILE_NAME, localData);
            renderJournals();
        }
    </script>
</body>
</html>
